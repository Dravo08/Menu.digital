<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Owner Dashboard with Menu Management</title>
  <style>
    body { font-family: sans-serif; padding: 20px; background: #fff8e1; }
    h1, h2 { color: #4e342e; }
    .order, .menu-item, .menu-edit-form { background: white; margin: 10px 0; padding: 10px; border-left: 5px solid #795548; }
    input, select, button { margin: 5px 0; padding: 5px; font-size: 1rem; }
    .menu-item > div { display: flex; align-items: center; gap: 10px; }
    .menu-item > div > input, select { width: 150px; }
    .menu-item > div > button { padding: 5px 10px; }
    #logout { background:#795548; color:#fff; border:none; padding:8px 12px; cursor:pointer; margin-bottom: 15px;}
  </style>
</head>
<body>
  <h1>ğŸ‘¨â€ğŸ’¼ Owner Panel</h1>
  <button id="logout">Logout</button>

  <h2>ğŸ“ˆ Today's Sales</h2>
  <div id="sales-summary">Loading...</div>

  <h2>ğŸ§¾ Order History</h2>
  <div id="orders"></div>

  <h2>ğŸ½ï¸ Manage Menu Items</h2>

  <!-- Add New Item Form -->
  <form id="add-menu-form" class="menu-edit-form">
    <input type="text" id="new-name" placeholder="Item Name" required />
    <input type="number" id="new-price" placeholder="Price (Rs.)" required min="0" />
    <input type="text" id="new-category" placeholder="Category" required />
    <button type="submit">Add Item</button>
  </form>

  <div id="menu"></div>

  <script type="module">
    import { db } from './firebase.js';
    import { ref, onValue, push, update, remove } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-database.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-auth.js";

    const auth = getAuth();
    onAuthStateChanged(auth, (user) => {
      if (!user) {
        window.location.href = "login.html"; // force login
      }
    });

    document.getElementById('logout').addEventListener('click', () => {
      signOut(auth).then(() => {
        window.location.href = 'login.html';
      });
    });

    const ordersRef = ref(db, 'orders');
    const menuRef = ref(db, 'menu');
    const ordersDiv = document.getElementById('orders');
    const menuDiv = document.getElementById('menu');
    const salesDiv = document.getElementById('sales-summary');

    // Show order history + today's sales
    onValue(ordersRef, (snapshot) => {
      const data = snapshot.val() || {};
      let totalSales = 0;
      const today = new Date().toDateString();

      ordersDiv.innerHTML = '';
      for (let id in data) {
        const order = data[id];
        const date = new Date(order.timestamp);
        const isToday = date.toDateString() === today;

        const div = document.createElement('div');
        div.className = 'order';
        div.innerHTML = `
          <strong>${order.name}</strong><br>
          Rs. ${order.price}<br>
          <small>${date.toLocaleString()}</small>
        `;
        ordersDiv.prepend(div);

        if (isToday) totalSales += Number(order.price);
      }
      salesDiv.innerText = `Rs. ${totalSales} (from today's orders)`;
    });

    // Render menu items with edit/delete options
    onValue(menuRef, (snapshot) => {
      const data = snapshot.val() || {};
      menuDiv.innerHTML = '';
      for (let id in data) {
        const item = data[id];

        const div = document.createElement('div');
        div.className = 'menu-item';

        div.innerHTML = `
          <div>
            <input type="text" value="${item.name}" data-id="${id}" data-field="name" />
            <input type="number" value="${item.price}" data-id="${id}" data-field="price" min="0" />
            <input type="text" value="${item.category}" data-id="${id}" data-field="category" />
            <button data-id="${id}" class="save-btn">Save</button>
            <button data-id="${id}" class="delete-btn" style="background:#e53935; color:#fff;">Delete</button>
          </div>
        `;

        menuDiv.appendChild(div);
      }

      // Attach event listeners after rendering
      document.querySelectorAll('.save-btn').forEach(btn => {
        btn.onclick = () => {
          const id = btn.dataset.id;
          const name = document.querySelector(`input[data-id="${id}"][data-field="name"]`).value.trim();
          const price = parseFloat(document.querySelector(`input[data-id="${id}"][data-field="price"]`).value);
          const category = document.querySelector(`input[data-id="${id}"][data-field="category"]`).value.trim();

          if (!name || isNaN(price) || !category) {
            alert("Please fill all fields correctly.");
            return;
          }

          update(ref(db, `menu/${id}`), { name, price, category })
            .then(() => alert("Updated successfully"))
            .catch(e => alert("Update failed: " + e.message));
        };
      });

      document.querySelectorAll('.delete-btn').forEach(btn => {
        btn.onclick = () => {
          const id = btn.dataset.id;
          if (confirm("Are you sure you want to delete this item?")) {
            remove(ref(db, `menu/${id}`))
              .catch(e => alert("Delete failed: " + e.message));
          }
        };
      });
    });

    // Handle add new item form submit
    document.getElementById('add-menu-form').onsubmit = (e) => {
      e.preventDefault();

      const nameInput = document.getElementById('new-name');
      const priceInput = document.getElementById('new-price');
      const categoryInput = document.getElementById('new-category');

      const name = nameInput.value.trim();
      const price = parseFloat(priceInput.value);
      const category = categoryInput.value.trim();

      if (!name || isNaN(price) || !category) {
        alert("Please fill all fields correctly.");
        return;
      }

      push(menuRef, { name, price, category })
        .then(() => {
          alert("Added new menu item!");
          nameInput.value = '';
          priceInput.value = '';
          categoryInput.value = '';
        })
        .catch(e => alert("Failed to add: " + e.message));
    };
  </script>
</body>
</html>